<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>community help poc</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS for the map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Leaflet.markercluster for dot clustering -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Custom styles for the app */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent; /* Removes blue tap highlight on mobile */
        }

        /* Page transition styles */
        .page {
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
            will-change: opacity, transform;
            position: absolute;
            inset: 0;
            top: 0; /* All pages now start at the top of their container */
        }
        
        #page-map-container { /* Special container for map to handle header overlay */
            top: 0; 
        }

        .page-hidden {
            opacity: 0;
            transform: scale(0.98);
            pointer-events: none;
            display: none !important;
        }
        
        /* Custom select arrow */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.2em;
            padding-right: 2.5rem;
        }

        /* Toggle button active state */
        .toggle-active {
            color: #2563eb; /* blue-600 */
            border-bottom: 2px solid #2563eb;
        }

        /* Leaflet attribution control in bottom left */
        .leaflet-bottom.leaflet-left {
            bottom: 10px;
        }

        /* Marker cluster custom styling */
        .marker-cluster-small,
        .marker-cluster-medium,
        .marker-cluster-large {
            background-color: rgba(239, 68, 68, 0.6); /* bg-red-500 with opacity */
        }
        .marker-cluster-small div,
        .marker-cluster-medium div,
        .marker-cluster-large div {
            background-color: rgba(220, 38, 38, 0.8); /* bg-red-600 with opacity */
            color: #fff;
            font-weight: bold;
        }
        
        /* Ensure all text is lowercase via CSS as a fallback */
        h1, h2, h3, p, span, div, button, select, option, label {
            text-transform: lowercase;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden antialiased">

    <div id="app-container" class="relative h-full max-w-lg mx-auto bg-white shadow-2xl overflow-hidden flex flex-col">

        <!-- Top Toggle Header -->
        <header id="main-header" class="w-full bg-white/80 backdrop-blur-sm p-2 flex justify-around items-center border-b border-gray-200 z-20 flex-shrink-0" style="height: 64px;">
            <button id="toggle-map" class="toggle-active flex flex-col items-center justify-center h-full w-full text-gray-500 pb-1 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                <span class="text-xs font-medium">give</span>
            </button>
            <button id="toggle-profile" class="flex flex-col items-center justify-center h-full w-full text-gray-500 pb-1 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                <span class="text-xs font-medium">profile</span>
            </button>
        </header>

        <!-- Page Container -->
        <div id="page-content-container" class="flex-grow relative">
            <!-- Page 1: Map & Category Selection (wrapped) -->
            <div id="page-map-container" class="page flex flex-col h-full !top-0">
                <div id="map" class="flex-grow"></div>
                <div class="p-6 bg-white rounded-t-2xl shadow-lg -mt-4 z-10 flex-shrink-0">
                    <h1 class="text-xl font-bold text-gray-800 text-center">i‚Äôm here to help my community by giving‚Ä¶</h1>
                    <div class="mt-4">
                        <select id="category-select" class="w-full bg-gray-100 border-2 border-gray-200 text-gray-700 py-3 px-4 pr-8 rounded-lg focus:outline-none focus:bg-white focus:border-blue-500 text-lg">
                            <option value="" disabled selected>select an item...</option>
                            <option value="food">food</option>
                            <option value="water">water</option>
                            <option value="clothing">clothing</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Page 2: Nearby Needs List -->
            <div id="page-list" class="page page-hidden bg-gray-50 flex flex-col p-6 overflow-y-auto">
                <h2 id="list-header" class="text-2xl font-bold text-gray-800 mb-6"></h2>
                <div id="needs-list" class="space-y-4"></div>
            </div>

            <!-- Page 3: Location Details & Commitment -->
            <div id="page-details" class="page page-hidden bg-white p-6 flex flex-col">
                <header class="flex-shrink-0">
                    <button id="back-to-list" class="text-3xl text-gray-500 hover:text-blue-500 transition-colors">‚Üê</button>
                </header>
                <main class="flex-grow flex flex-col justify-center items-center text-center px-4">
                    <p id="details-text" class="text-2xl font-medium text-gray-700 leading-relaxed"></p>
                    <div class="mt-10 w-full max-w-xs">
                        <label for="quantity-select" class="block text-lg font-semibold text-gray-600 mb-2">how many people would you be able to help?</label>
                        <select id="quantity-select" class="w-full bg-gray-100 border-2 border-gray-200 text-gray-700 py-3 px-4 pr-8 rounded-lg focus:outline-none focus:bg-white focus:border-blue-500 text-lg"></select>
                    </div>
                </main>
                <footer class="flex-shrink-0">
                    <button id="submit-button" class="w-full bg-blue-600 text-white font-bold py-4 px-4 rounded-xl text-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all transform hover:scale-105">submit</button>
                </footer>
            </div>

            <!-- Page 4: Confirmation Screen -->
            <div id="page-confirmation" class="page page-hidden bg-white p-8 flex flex-col justify-center items-center text-center">
                 <div id="badge-unlock-notification" class="w-full text-center mb-6"></div>
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-6">
                    <svg class="w-12 h-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </div>
                <p id="confirmation-text" class="text-xl font-medium text-gray-700 leading-relaxed"></p>
                <button id="restart-button" class="mt-12 w-full max-w-sm bg-blue-600 text-white font-bold py-4 px-4 rounded-xl text-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all transform hover:scale-105">help more people in your area!</button>
            </div>

            <!-- Profile Page (new) -->
            <div id="page-profile" class="page page-hidden bg-gray-50 p-6 flex flex-col items-center overflow-y-auto">
                <div class="w-full max-w-sm text-center flex-shrink-0">
                    <div class="relative inline-block">
                        <label for="profile-pic-upload" class="cursor-pointer group">
                            <img id="profile-pic" src="https://api.dicebear.com/8.x/adventurer/svg?seed=Maddie" alt="User Avatar" class="w-32 h-32 rounded-full mx-auto border-4 border-white shadow-lg group-hover:opacity-75 transition-opacity">
                             <div class="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            </div>
                        </label>
                        <input type="file" id="profile-pic-upload" class="hidden" accept="image/*">
                    </div>
                    <h2 class="text-3xl font-bold text-gray-800 mt-4">maddie bhuvan</h2>
                    <p class="text-md text-gray-500">san francisco</p>
                    <!-- Stats Section -->
                    <div class="mt-6 flex justify-around w-full border-t border-b border-gray-200 py-3">
                        <div class="text-center">
                            <p id="profile-donations-count" class="text-2xl font-bold text-gray-800">0</p>
                            <p class="text-sm text-gray-500">donations</p>
                        </div>
                        <div class="text-center">
                            <p id="profile-following-count" class="text-2xl font-bold text-gray-800">0</p>
                            <p class="text-sm text-gray-500">following</p>
                        </div>
                        <div class="text-center">
                            <p id="profile-followers-count" class="text-2xl font-bold text-gray-800">0</p>
                            <p class="text-sm text-gray-500">followers</p>
                        </div>
                    </div>
                </div>
                <div class="mt-8 w-full max-w-sm space-y-4 flex-shrink-0">
                     <button id="achievements-btn" class="w-full bg-white text-gray-800 font-bold py-4 px-4 rounded-xl text-lg border-2 border-gray-200 hover:border-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all">my achievements</button>
                     <button id="in-progress-btn" class="w-full bg-white text-gray-800 font-bold py-4 px-4 rounded-xl text-lg border-2 border-gray-200 hover:border-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all">donations in progress</button>
                     <button id="friends-btn" class="w-full bg-white text-gray-800 font-bold py-4 px-4 rounded-xl text-lg border-2 border-gray-200 hover:border-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all">friends</button>
                     <button id="community-btn" class="w-full bg-white text-gray-800 font-bold py-4 px-4 rounded-xl text-lg border-2 border-gray-200 hover:border-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all">community</button>
                </div>
            </div>

            <!-- Friends Leaderboard Page (new) -->
            <div id="page-leaderboard" class="page page-hidden bg-gray-50 flex flex-col">
                <header class="p-4 border-b bg-white/80 backdrop-blur-sm z-10 flex items-center">
                    <button class="back-button text-3xl text-gray-500 mr-4">‚Üê</button>
                    <h2 class="text-xl font-bold text-gray-800">october friends leaderboard</h2>
                </header>
                <div id="leaderboard-list" class="p-4 space-y-3 overflow-y-auto"></div>
            </div>
            
            <!-- Achievements Page (new) -->
             <div id="page-achievements" class="page page-hidden bg-gray-50 flex flex-col">
                <header class="p-4 border-b bg-white/80 backdrop-blur-sm z-10 flex items-center">
                    <button class="back-button text-3xl text-gray-500 mr-4">‚Üê</button>
                    <h2 class="text-xl font-bold text-gray-800">my achievements</h2>
                </header>
                <div id="achievements-list" class="p-4 space-y-3 overflow-y-auto"></div>
            </div>

            <!-- Donations In Progress Page (new) -->
             <div id="page-in-progress" class="page page-hidden bg-gray-50 flex flex-col">
                <header class="p-4 border-b bg-white/80 backdrop-blur-sm z-10 flex items-center">
                    <button class="back-button text-3xl text-gray-500 mr-4">‚Üê</button>
                    <h2 class="text-xl font-bold text-gray-800">donations in progress</h2>
                </header>
                <div id="in-progress-list" class="p-4 space-y-3 overflow-y-auto"></div>
            </div>

            <!-- Community Heat Map Page (new) -->
            <div id="page-heatmap" class="page page-hidden bg-gray-50 flex flex-col">
                <header class="p-4 border-b bg-white/80 backdrop-blur-sm z-10 flex items-center">
                    <button class="back-button text-3xl text-gray-500 mr-4">‚Üê</button>
                    <h2 class="text-xl font-bold text-gray-800">community heat map</h2>
                </header>
                <div class="p-4 text-center bg-white text-sm text-gray-600">
                    <p><strong id="october-donations-total" class="text-blue-600"></strong> donations made in san francisco in october 2025.</p>
                    <p><strong id="cumulative-donations-total" class="text-blue-600"></strong> donations made in san francisco so far.</p>
                    <p class="mt-2 text-xs"><strong>maria s.</strong> was the top contributor this month!</p>
                </div>
                <div class="relative flex-grow">
                    <div id="heatmap" class="absolute inset-0"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        const appState = {
            userLocation: [37.7665, -122.4221], // Pebblebed
            selectedCategory: null,
            selectedLocation: null,
            generatedDetails: { people: null, timeWindow: null, startTime: null },
            committedQuantity: null,
            cumulativeDonations: 0, // Will be initialized based on October + previous months
            octoberDonations: 0, // Will be calculated from neighborhood data
            currentView: 'map',
            fixedMarkers: [], // To store consistent marker locations
            followingCount: 0,
            followersCount: 0,
            inProgressDonations: [],
            achievedBadges: [],
        };

        // --- MOCK DATA ---
        const locationsData = {
            food: [ { id: 1, name: "mission community kitchen", distance: 0.8 }, { id: 2, name: "soma food pantry", distance: 1.2 }, { id: 3, name: "bayview community fridge", distance: 2.5 }, { id: 4, name: "tenderloin homeless shelter", distance: 1.9 }, { id: 5, name: "sunset district drop-off", distance: 4.1 }, ],
            water: [ { id: 4, name: "tenderloin homeless shelter", distance: 1.9 }, { id: 6, name: "golden gate park hydration station", distance: 3.5 }, { id: 1, name: "mission community kitchen", distance: 0.8 }, { id: 7, name: "civic center plaza aid", distance: 1.5 }, { id: 8, name: "embarcadero relief point", distance: 2.8 }, { id: 2, name: "soma food pantry", distance: 1.2 }, ],
            clothing: [ { id: 9, name: "haight-ashbury donation center", distance: 2.2 }, { id: 4, name: "tenderloin homeless shelter", distance: 1.9 }, { id: 10, name: "goodwill mission creek", distance: 0.9 }, { id: 11, name: "richmond district family closet", distance: 4.8 }, { id: 12, name: "bayview salvation army", distance: 2.6 }, ],
        };
        const friendsData = [
            { id: 1, name: 'maddie bhuvan', donations: 22, avatar: 'https://api.dicebear.com/8.x/adventurer/svg?seed=Maddie' },
            { id: 2, name: 'roopa srinivas', donations: 20, avatar: 'https://api.dicebear.com/8.x/adventurer/svg?seed=Beatrice' },
            { id: 3, name: 'charles brown', donations: 18, avatar: 'https://api.dicebear.com/8.x/adventurer/svg?seed=Charles' },
            { id: 4, name: 'diana marie', donations: 15, avatar: 'https://api.dicebear.com/8.x/adventurer/svg?seed=Diana' },
            { id: 5, name: 'edward ray', donations: 11, avatar: 'https://api.dicebear.com/8.x/adventurer/svg?seed=Edward' },
            { id: 6, name: 'franklin green', donations: 9, avatar: 'https://api.dicebear.com/8.x/adventurer/svg?seed=Franklin' },
            { id: 7, name: 'gloria hill', donations: 8, avatar: 'https://api.dicebear.com/8.x/adventurer/svg?seed=Gloria' },
            { id: 8, name: 'henry irwin', donations: 7, avatar: 'https://api.dicebear.com/8.x/adventurer/svg?seed=Henry' },
            { id: 9, name: 'isabella jones', donations: 5, avatar: 'https://api.dicebear.com/8.x/adventurer/svg?seed=Isabella' },
            { id: 10, name: 'jack king', donations: 3, avatar: 'https://api.dicebear.com/8.x/adventurer/svg?seed=Jack' },
            { id: 11, name: 'karen lewis', donations: 2, avatar: 'https://api.dicebear.com/8.x/adventurer/svg?seed=Karen' },
        ];
        const neighborhoods = {
            "mission district": { coords: [37.7599, -122.4194], donations: 450 },
            "soma": { coords: [37.778, -122.405], donations: 320 },
            "tenderloin": { coords: [37.784, -122.415], donations: 510 },
            "bayview": { coords: [37.73, -122.38], donations: 250 },
            "sunset district": { coords: [37.75, -122.48], donations: 180 },
            "noe valley": { coords: [37.751, -122.433], donations: 0 },
        };

        const badgeList = [
            { milestone: 1, title: 'kindling kindness', icon: `<path stroke-linecap="round" stroke-linejoin="round" d="M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048 8.287 8.287 0 009 9.6a8.983 8.983 0 013.362-3.797z" />` },
            { milestone: 5, title: 'neighborhood nurturer', icon: `<path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h6.75M9 11.25h6.75M9 15.75h6.75M9 20.25h6.75M4.5 6.75h.75m-.75 4.5h.75m-.75 4.5h.75m-.75 4.5h.75m13.5-13.5h-.75m.75 4.5h-.75m.75 4.5h-.75m.75 4.5h-.75M12 3v1.5m0 16.5V21" />` },
            { milestone: 10, title: 'local hero', icon: `<path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-3.152a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" />` },
            { milestone: 25, title: 'community champion', icon: `<path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9a9.75 9.75 0 001.316-5.033 9.75 9.75 0 001.638-4.965 9.75 9.75 0 00-2.3-6.452 9.75 9.75 0 00-6.418-2.6A9.75 9.75 0 001.5 9.75c0 5.428 4.418 8.25 9.75 8.25 1.763 0 3.27-.234 4.5-.632zM21 9.75a9.75 9.75 0 00-9.75-9.75c-1.354 0-2.64.264-3.832.723" />`},
            { milestone: 50, title: 'guardian of goodness', icon: `<path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.286zm0 13.036h.008v.008h-.008v-.008z" />` },
            { milestone: 100, title: 'humanity‚Äôs beacon', icon: `<path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 001.5-.184m-1.5.184a6.01 6.01 0 01-1.5-.184m3.75 3.636l-1.096-2.247m1.096 2.247a6.01 6.01 0 012.382-1.355M12 21a9 9 0 110-18 9 9 0 010 18z" />` },
            { milestone: 200, title: 'legend of the locals (+200)', icon: `<path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-3.152a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" />` },
        ];


        // A more detailed polygon representing San Francisco's landmass.
        const sfLandPolygon = [[[-122.43,37.81],[-122.42,37.81],[-122.41,37.81],[-122.4,37.81],[-122.4,37.81],[-122.41,37.8],[-122.41,37.8],[-122.41,37.8],[-122.41,37.8],[-122.41,37.8],[-122.41,37.8],[-122.42,37.8],[-122.42,37.8],[-122.43,37.8],[-122.43,37.8],[-122.44,37.8],[-122.44,37.8],[-122.44,37.8],[-122.44,37.8],[-122.44,37.8],[-122.44,37.81],[-122.44,37.81],[-122.45,37.81],[-122.45,37.81],[-122.46,37.81],[-122.46,37.81],[-122.47,37.81],[-122.47,37.81],[-122.47,37.81],[-122.47,37.81],[-122.47,37.81],[-122.48,37.81],[-122.48,37.81],[-122.48,37.81],[-122.49,37.81],[-122.49,37.8],[-122.5,37.8],[-122.5,37.8],[-122.51,37.8],[-122.51,37.8],[-122.51,37.79],[-122.51,37.79],[-122.51,37.78],[-122.51,37.78],[-122.51,37.77],[-122.51,37.77],[-122.51,37.76],[-122.51,37.75],[-122.51,37.74],[-122.51,37.74],[-122.51,37.73],[-122.51,37.72],[-122.51,37.71],[-122.5,37.71],[-122.49,37.71],[-122.49,37.71],[-122.48,37.71],[-122.47,37.71],[-122.46,37.71],[-122.46,37.72],[-122.45,37.72],[-122.45,37.73],[-122.45,37.73],[-122.45,37.74],[-122.45,37.74],[-122.45,37.74],[-122.45,37.75],[-122.45,37.75],[-122.45,37.76],[-122.45,37.76],[-122.45,37.77],[-122.46,37.77],[-122.46,37.78],[-122.46,37.78],[-122.47,37.78],[-122.47,37.78],[-122.48,37.78],[-122.48,37.78],[-122.48,37.78],[-122.49,37.78],[-122.49,37.78],[-122.49,37.78],[-122.5,37.78],[-122.5,37.78],[-122.5,37.78],[-122.5,37.78],[-122.5,37.79],[-122.5,37.79],[-122.5,37.79],[-122.5,37.79],[-122.49,37.79],[-122.49,37.8],[-122.49,37.8],[-122.49,37.8],[-122.49,37.8],[-122.48,37.8],[-122.48,37.8],[-122.48,37.8],[-122.48,37.8],[-122.47,37.8],[-122.47,37.8],[-122.47,37.8],[-122.47,37.8],[-122.47,37.8],[-122.46,37.8],[-122.46,37.8],[-122.46,37.8],[-122.46,37.8],[-122.45,37.8],[-122.45,37.8],[-122.45,37.8],[-122.45,37.8],[-122.44,37.8],[-122.44,37.8],[-122.44,37.79],[-122.44,37.79],[-122.43,37.79],[-122.43,37.79],[-122.43,37.79],[-122.42,37.79],[-122.42,37.79],[-122.42,37.78],[-122.41,37.78],[-122.41,37.78],[-122.4,37.78],[-122.4,37.78],[-122.39,37.78],[-122.39,37.78],[-122.39,37.78],[-122.39,37.77],[-122.39,37.77],[-122.39,37.77],[-122.39,37.76],[-122.39,37.76],[-122.39,37.75],[-122.39,37.75],[-122.39,37.74],[-122.39,37.74],[-122.39,37.73],[-122.39,37.73],[-122.4,37.73],[-122.4,37.72],[-122.4,37.72],[-122.4,37.71],[-122.4,37.71],[-122.41,37.71],[-122.41,37.71],[-122.41,37.71],[-122.41,37.7],[-122.41,37.7],[-122.42,37.7],[-122.42,37.7],[-122.42,37.69],[-122.43,37.69],[-122.43,37.69],[-122.43,37.68],[-122.43,37.68],[-122.44,37.68],[-122.44,37.67],[-122.44,37.67],[-122.44,37.66],[-122.44,37.66],[-122.44,37.65],[-122.44,37.65],[-122.44,37.64],[-122.44,37.64],[-122.45,37.64],[-122.45,37.64],[-122.45,37.64],[-122.46,37.64],[-122.46,37.64],[-122.46,37.64],[-122.47,37.64],[-122.47,37.64],[-122.47,37.64],[-122.47,37.64],[-122.48,37.64],[-122.48,37.64],[-122.48,37.64],[-122.48,37.63],[-122.48,37.63],[-122.49,37.63],[-122.49,37.63],[-122.49,37.64],[-122.49,37.64],[-122.5,37.64],[-122.5,37.64],[-122.5,37.64],[-122.5,37.65],[-122.5,37.65],[-122.5,37.65],[-122.5,37.66],[-122.5,37.66],[-122.5,37.66],[-122.5,37.67],[-122.5,37.67],[-122.5,37.67],[-122.5,37.68],[-122.5,37.68],[-122.5,37.68],[-122.5,37.69],[-122.5,37.69],[-122.5,37.69],[-122.5,37.7],[-122.5,37.7],[-122.5,37.7],[-122.5,37.7],[-122.49,37.7],[-122.49,37.7],[-122.48,37.7],[-122.48,37.71],[-122.47,37.71],[-122.46,37.71],[-122.45,37.71],[-122.45,37.71],[-122.44,37.71],[-122.44,37.72],[-122.44,37.72],[-122.44,37.72],[-122.44,37.73],[-122.44,37.73],[-122.44,37.74],[-122.44,37.74],[-122.44,37.75],[-122.44,37.75],[-122.44,37.76],[-122.44,37.76],[-122.44,37.77],[-122.44,37.77],[-122.44,37.77],[-122.44,37.78],[-122.44,37.78],[-122.43,37.78],[-122.43,37.78],[-122.43,37.78],[-122.42,37.78],[-122.42,37.78],[-122.42,37.78],[-122.41,37.78],[-122.41,37.79],[-122.4,37.79],[-122.4,37.79],[-122.39,37.79],[-122.38,37.79],[-122.38,37.79],[-122.37,37.79],[-122.37,37.79],[-122.36,37.79],[-122.36,37.79],[-122.36,37.78],[-122.36,37.78],[-122.36,37.78],[-122.36,37.78],[-122.36,37.77],[-122.36,37.77],[-122.36,37.77],[-122.36,37.76],[-122.36,37.76],[-122.36,37.75],[-122.36,37.75],[-122.37,37.75],[-122.37,37.74],[-122.37,37.74],[-122.37,37.73],[-122.37,37.73],[-122.37,37.72],[-122.38,37.72],[-122.38,37.71],[-122.38,37.71],[-122.38,37.71],[-122.39,37.71],[-122.39,37.71],[-122.39,37.71],[-122.39,37.71],[-122.39,37.72],[-122.39,37.72],[-122.39,37.72],[-122.39,37.72],[-122.4,37.73],[-122.4,37.73],[-122.4,37.73],[-122.4,37.73],[-122.4,37.73],[-122.4,37.74],[-122.4,37.74],[-122.4,37.74],[-122.4,37.74],[-122.4,37.75],[-122.4,37.75],[-122.4,37.75],[-122.4,37.75],[-122.4,37.75],[-122.4,37.76],[-122.4,37.76],[-122.4,37.76],[-122.4,37.76],[-122.4,37.76],[-122.4,37.77],[-122.4,37.77],[-122.4,37.77],[-122.4,37.77],[-122.4,37.77],[-122.4,37.77],[-122.4,37.78],[-122.4,37.78],[-122.4,37.78],[-122.4,37.78],[-122.41,37.78],[-122.41,37.78],[-122.41,37.78],[-122.41,37.78],[-122.41,37.78],[-122.41,37.79],[-122.41,37.79],[-122.41,37.79],[-122.41,37.79],[-122.41,37.79],[-122.42,37.8],[-122.42,37.8],[-122.42,37.8],[-122.42,37.8],[-122.42,37.8],[-122.43,37.81],[-122.43,37.81],[-122.43,37.81]]];
        let bufferedSfLandPolygon;

        // --- DOM ELEMENTS ---
        const pages = {
            map: document.getElementById('page-map-container'),
            list: document.getElementById('page-list'),
            details: document.getElementById('page-details'),
            confirmation: document.getElementById('page-confirmation'),
            profile: document.getElementById('page-profile'),
            leaderboard: document.getElementById('page-leaderboard'),
            heatmap: document.getElementById('page-heatmap'),
            achievements: document.getElementById('page-achievements'),
            inProgress: document.getElementById('page-in-progress'),
        };
        const pageContentContainer = document.getElementById('page-content-container');
        const toggleMapBtn = document.getElementById('toggle-map');
        const toggleProfileBtn = document.getElementById('toggle-profile');
        const categorySelect = document.getElementById('category-select');
        const listHeader = document.getElementById('list-header');
        const needsList = document.getElementById('needs-list');
        const backToListBtn = document.getElementById('back-to-list');
        const detailsText = document.getElementById('details-text');
        const quantitySelect = document.getElementById('quantity-select');
        const submitButton = document.getElementById('submit-button');
        const confirmationText = document.getElementById('confirmation-text');
        const restartButton = document.getElementById('restart-button');
        const friendsBtn = document.getElementById('friends-btn');
        const communityBtn = document.getElementById('community-btn');
        const achievementsBtn = document.getElementById('achievements-btn');
        const inProgressBtn = document.getElementById('in-progress-btn');
        const backButtons = document.querySelectorAll('.back-button');
        const profilePicUpload = document.getElementById('profile-pic-upload');
        const profileFollowingCountEl = document.getElementById('profile-following-count');
        const profileFollowersCountEl = document.getElementById('profile-followers-count');
        const profileDonationsCountEl = document.getElementById('profile-donations-count');
        const badgeUnlockNotification = document.getElementById('badge-unlock-notification');

        // --- PAGE NAVIGATION ---
        function navigateTo(pageKey, fromPage = null) {
            appState.currentView = pageKey;
            
            // Handle active state on top toggle
            if (['profile', 'leaderboard', 'heatmap', 'achievements', 'inProgress'].includes(pageKey)) {
                toggleProfileBtn.classList.add('toggle-active');
                toggleMapBtn.classList.remove('toggle-active');
            } else {
                toggleMapBtn.classList.add('toggle-active');
                toggleProfileBtn.classList.remove('toggle-active');
            }

            // Hide all pages first
            Object.values(pages).forEach(page => page.classList.add('page-hidden'));

            // Show target page
            if (pages[pageKey]) {
                setTimeout(() => {
                    pages[pageKey].style.display = 'flex'; // Use flex for consistency
                    setTimeout(() => pages[pageKey].classList.remove('page-hidden'), 10);
                }, 50);
            }
        }

        // --- UTILITY FUNCTIONS ---
        // Ray-casting algorithm to check if a point is inside a polygon.
        function isPointInPolygon(point, vs) {
            const x = point[0], y = point[1];
            let inside = false;
            for (let i = 0, j = vs.length - 1; i < vs.length; j = i++) {
                const xi = vs[i][0], yi = vs[i][1];
                const xj = vs[j][0], yj = vs[j][1];
                const intersect = ((yi > y) != (yj > y))
                    && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            return inside;
        };
        
        // Creates a new polygon inset from the original to act as a coastal buffer
        function createBufferedPolygon(polygon, buffer) {
            const originalPolygon = polygon[0];
            // Calculate the centroid (average point) of the polygon
            let sumX = 0, sumY = 0;
            originalPolygon.forEach(p => {
                sumX += p[0];
                sumY += p[1];
            });
            const centerX = sumX / originalPolygon.length;
            const centerY = sumY / originalPolygon.length;

            const buffered = originalPolygon.map(point => {
                const vectorX = centerX - point[0];
                const vectorY = centerY - point[1];
                // Move the point inward along the vector from the center
                return [point[0] + vectorX * buffer, point[1] + vectorY * buffer];
            });
            return [buffered];
        }

        // --- MAP INITIALIZATION ---
        let map;
        let markers;

        function generateInitialMarkers(count = 300) {
            const generatedMarkers = [];
            let attempts = 0;
            const maxAttempts = count * 30; // Give it plenty of tries to find points on land
            // Define a bounding box roughly around San Francisco to generate points within.
            const generationBounds = L.latLngBounds([37.7, -122.52], [37.82, -122.36]);

            while (generatedMarkers.length < count && attempts < maxAttempts) {
                const lat = generationBounds.getSouth() + Math.random() * (generationBounds.getNorth() - generationBounds.getSouth());
                const lng = generationBounds.getWest() + Math.random() * (generationBounds.getEast() - generationBounds.getWest());
                
                // Use the buffered polygon for the check
                if (isPointInPolygon([lng, lat], bufferedSfLandPolygon[0])) {
                    generatedMarkers.push([lat, lng]);
                }
                attempts++;
            }
            appState.fixedMarkers = generatedMarkers;
        }

        function initMap() {
            if (map) return;
            map = L.map('map').setView(appState.userLocation, 14);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '&copy; openstreetmap &copy; carto', subdomains: 'abcd', maxZoom: 20 }).addTo(map);
            L.circle(appState.userLocation, { color: '#3b82f6', fillColor: '#60a5fa', fillOpacity: 0.5, radius: 50 }).addTo(map);
            L.circle(appState.userLocation, { color: 'rgba(59, 130, 246, 0.3)', fillColor: 'rgba(96, 165, 250, 0.1)', fillOpacity: 0.2, radius: 2133.6, weight: 2 }).addTo(map);
            
            // Initialize marker cluster group
            markers = L.markerClusterGroup({
                // Customize cluster icon appearance
                iconCreateFunction: function(cluster) {
                    return L.divIcon({
                        html: `<div><span>${cluster.getChildCount()}</span></div>`,
                        className: 'marker-cluster marker-cluster-small',
                        iconSize: new L.Point(40, 40)
                    });
                },
                // Disable spider-like expansion on click, which can be messy
                spiderfyOnMaxZoom: false,
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true
            });
            
            generateInitialMarkers(); // Generate the fixed set of markers
            
            // Add the generated markers to the cluster group
            appState.fixedMarkers.forEach(coords => {
                 const marker = L.circleMarker(coords, { color: '#ef4444', radius: 6, fillOpacity: 0.8, weight: 0 });
                 markers.addLayer(marker);
            });
            
            map.addLayer(markers); // Add the entire cluster group to the map
        }
        
        // --- HEATMAP INITIALIZATION ---
        let heatMap;
        let communityLayer;

        function updateHeatmapHeader() {
            document.getElementById('october-donations-total').textContent = appState.octoberDonations.toLocaleString();
            document.getElementById('cumulative-donations-total').textContent = appState.cumulativeDonations.toLocaleString();
        }

        function initHeatMap() {
            if (heatMap) return;
            updateHeatmapHeader();
            heatMap = L.map('heatmap').setView(appState.userLocation, 12);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', { attribution: '&copy; openstreetmap &copy; carto', subdomains: 'abcd', maxZoom: 20 }).addTo(heatMap);
            drawCommunityCircles();
        }

        function getColorForDonations(d, maxDonations) {
            // This function maps a donation value to a green shade
            // Using HSL for easy lightness manipulation (from light green to dark green)
            const percentage = Math.max(0, d / maxDonations);
            const lightness = 90 - (percentage * 55); // Scale from 90% (light) to 35% (dark)
            return `hsl(145, 60%, ${lightness}%)`;
        }
        
        function drawCommunityCircles() {
            if (communityLayer) {
                heatMap.removeLayer(communityLayer);
            }
            communityLayer = L.layerGroup().addTo(heatMap);

            const donationValues = Object.values(neighborhoods).map(n => n.donations).filter(d => d > 0);
            if (donationValues.length === 0) return; // Don't draw if no donations
            const maxDonations = Math.max(...donationValues);

            for (const name in neighborhoods) {
                const neighborhood = neighborhoods[name];
                if (neighborhood.donations > 0) {
                    const color = getColorForDonations(neighborhood.donations, maxDonations);

                    const circle = L.circle(neighborhood.coords, {
                        color: '#14532d', // A dark green border
                        weight: 1.5,
                        fillColor: color,
                        fillOpacity: 0.75,
                        radius: 900 // ~900 meters radius for each community circle
                    }).addTo(communityLayer);

                    circle.bindPopup(`<b>${name}</b><br>${neighborhood.donations.toLocaleString()} donations this month.`);
                }
            }
        }

        // --- PAGE LOGIC ---
        function showNeedsList() {
            const category = appState.selectedCategory;
            const locations = locationsData[category.toLowerCase()].sort((a, b) => a.distance - b.distance);
            listHeader.textContent = `areas that need ${category} near you:`;
            needsList.innerHTML = ''; 
            locations.forEach(location => {
                const item = document.createElement('div');
                item.className = 'bg-white p-5 rounded-lg shadow-md border border-gray-200 cursor-pointer hover:shadow-xl hover:border-blue-500 transition-all transform hover:-translate-y-1';
                item.innerHTML = `<div class="flex justify-between items-center"><div><h3 class="text-lg font-semibold text-gray-800">${location.name}</h3><p class="text-gray-500">${location.distance} miles away</p></div><div class="text-2xl text-gray-400">‚Ä∫</div></div>`;
                item.onclick = () => { appState.selectedLocation = location; showDetailsPage(); };
                needsList.appendChild(item);
            });
            navigateTo('list');
        }

        function showDetailsPage() {
            const people = Math.floor(Math.random() * 15) + 5;
            const startHours = [16, 17, 18, 19, 20]; const randomStartHour = startHours[Math.floor(Math.random() * startHours.length)];
            const startTime = new Date(); startTime.setHours(randomStartHour, 30, 0);
            const endTime = new Date(startTime.getTime() + 3 * 60 * 60 * 1000);
            const formatTime = (date) => date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            const timeWindow = `${formatTime(startTime)}‚Äì${formatTime(endTime)}`;
            appState.generatedDetails = { people, timeWindow, startTime };
            detailsText.innerHTML = `<span class="font-bold text-blue-600">${people} people</span> at ${appState.selectedLocation.name} need <span class="font-bold text-blue-600">${appState.selectedCategory.toLowerCase()}</span> dropped off between ${timeWindow} today.`;
            quantitySelect.innerHTML = '';
            for (let i = 1; i <= people; i++) {
                const option = document.createElement('option'); option.value = i; option.textContent = i; quantitySelect.appendChild(option);
            }
            appState.committedQuantity = 1;
            navigateTo('details');
        }

        function checkAndAwardBadges(oldDonations, newDonations) {
            const newlyUnlocked = [];
            badgeList.forEach(badge => {
                // Check if the milestone was crossed
                if (oldDonations < badge.milestone && newDonations >= badge.milestone) {
                    newlyUnlocked.push(badge);
                    // Add to user's achieved list if not already there
                    if (!appState.achievedBadges.find(b => b.title === badge.title)) {
                        appState.achievedBadges.push({ ...badge, dateAchieved: new Date() });
                    }
                }
            });
            // Handle repeating +100 badges
            const oldHundredLevel = Math.floor(oldDonations / 100);
            const newHundredLevel = Math.floor(newDonations / 100);
            if (newHundredLevel > oldHundredLevel && newHundredLevel >= 2) {
                 for (let i = (oldHundredLevel + 1); i <= newHundredLevel; i++) {
                    const milestone = i * 100;
                    const badge = { milestone: milestone, title: `legend of the locals (+${milestone})`, icon: badgeList.find(b => b.milestone === 200).icon };
                    newlyUnlocked.push(badge);
                     if (!appState.achievedBadges.find(b => b.milestone === milestone)) {
                        appState.achievedBadges.push({ ...badge, dateAchieved: new Date() });
                    }
                 }
            }
            return newlyUnlocked;
        }

        function showConfirmationPage() {
            const committed = parseInt(appState.committedQuantity, 10);
            const user = friendsData.find(f => f.name === 'maddie bhuvan');
            const oldDonations = user ? user.donations : 0;
            
            // Update donation totals
            appState.cumulativeDonations += committed;
            appState.octoberDonations += committed;

            // Update neighborhood data randomly
            const neighborhoodKeys = Object.keys(neighborhoods);
            const randomNeighborhoodKey = neighborhoodKeys[Math.floor(Math.random() * neighborhoodKeys.length)];
            neighborhoods[randomNeighborhoodKey].donations += committed;
            
            // Update user's rank in friends list
            if (user) {
                user.donations += committed;
            }
            
            // Add to in-progress donations
            appState.inProgressDonations.push({
                locationName: appState.selectedLocation.name,
                timeWindow: appState.generatedDetails.timeWindow,
                startTime: appState.generatedDetails.startTime,
                summary: `${appState.selectedCategory} for ${committed} ${committed > 1 ? 'people' : 'person'}`
            });

            // Check for new badges
            badgeUnlockNotification.innerHTML = '';
            const newBadges = checkAndAwardBadges(oldDonations, user.donations);
            if (newBadges.length > 0) {
                newBadges.forEach(badge => {
                    const badgeEl = document.createElement('p');
                    badgeEl.className = 'text-lg font-semibold text-green-600';
                    badgeEl.innerHTML = `üèÖ "${badge.title}" badge unlocked! üèÖ`;
                    badgeUnlockNotification.appendChild(badgeEl);
                });
            }

            confirmationText.innerHTML = `you will help <strong>${committed} ${committed > 1 ? 'people' : 'person'}</strong> today! <strong>${appState.cumulativeDonations.toLocaleString()}</strong> people in sf helped so far.<br><br>thank you so much for being there for your community! please drop off your ${appState.selectedCategory.toLowerCase()} anytime between ${appState.generatedDetails.timeWindow} today. an email confirmation has been sent your way :)`;
            navigateTo('confirmation');
        }

        function showLeaderboardPage() {
            const listEl = document.getElementById('leaderboard-list');
            listEl.innerHTML = ''; // Clear previous list
            
            // Sort friends by donations to update ranks
            const sortedFriends = [...friendsData].sort((a,b) => b.donations - a.donations);

            sortedFriends.forEach((friend, index) => {
                const rank = index + 1;
                const item = document.createElement('div');
                item.className = `flex items-center p-3 rounded-lg ${friend.name === 'maddie bhuvan' ? 'bg-blue-100 border-2 border-blue-500' : 'bg-white shadow-sm'}`;
                item.innerHTML = `
                    <div class="font-bold text-lg text-gray-500 w-8 text-center">${rank}</div>
                    <label for="friend-pic-upload-${friend.id}" class="cursor-pointer mx-4 group relative">
                        <img id="friend-pic-${friend.id}" src="${friend.avatar}" class="w-12 h-12 rounded-full group-hover:opacity-60 transition-opacity">
                         <div class="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity text-white">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                         </div>
                    </label>
                    <input type="file" id="friend-pic-upload-${friend.id}" data-friendid="${friend.id}" class="hidden friend-pic-uploader" accept="image/*">
                    <div class="flex-grow">
                        <p class="font-semibold text-gray-800">${friend.name}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-blue-600">${friend.donations}</p>
                        <p class="text-xs text-gray-500">donations</p>
                    </div>`;
                listEl.appendChild(item);
            });
            navigateTo('leaderboard');
        }

        function updateProfileStats() {
            const user = friendsData.find(f => f.name === 'maddie bhuvan');
            if (user) {
                profileDonationsCountEl.textContent = user.donations;
            }
            profileFollowingCountEl.textContent = appState.followingCount;
            profileFollowersCountEl.textContent = appState.followersCount;
        }

        function showAchievementsPage() {
            const listEl = document.getElementById('achievements-list');
            listEl.innerHTML = '';
            const userDonations = friendsData.find(f => f.name === 'maddie bhuvan').donations;
            
            // Find next badge
            let nextBadge = null;
            for(const badge of badgeList) {
                if (userDonations < badge.milestone) {
                    nextBadge = badge;
                    break;
                }
            }
            if (!nextBadge && userDonations >= 100) { // Handle repeating legend badges
                 const nextHundred = Math.floor(userDonations / 100) * 100 + 100;
                 nextBadge = { milestone: nextHundred, title: `legend of the locals (+${nextHundred})`, icon: badgeList.find(b=> b.milestone === 200).icon};
            }

            // Display next badge (locked)
            if (nextBadge) {
                const item = document.createElement('div');
                item.className = 'flex items-center p-3 rounded-lg bg-gray-200 opacity-60';
                item.innerHTML = `
                    <div class="w-12 h-12 rounded-full bg-gray-300 flex items-center justify-center text-gray-500 mr-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                    </div>
                    <div class="flex-grow">
                        <p class="font-semibold text-gray-800">${nextBadge.title}</p>
                        <p class="text-xs text-gray-500">unlocks at ${nextBadge.milestone} donations</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-gray-600">${nextBadge.milestone}</p>
                    </div>`;
                listEl.appendChild(item);
            }

            // Display achieved badges (sorted newest first)
            const sortedAchieved = [...appState.achievedBadges].sort((a, b) => b.dateAchieved - a.dateAchieved);
            sortedAchieved.forEach(badge => {
                const item = document.createElement('div');
                item.className = 'flex items-center p-3 rounded-lg bg-white shadow-sm';
                item.innerHTML = `
                    <div class="w-12 h-12 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600 mr-4">
                         <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">${badge.icon}</svg>
                    </div>
                    <div class="flex-grow">
                        <p class="font-semibold text-gray-800">${badge.title}</p>
                        <p class="text-xs text-gray-500">achieved on ${badge.dateAchieved.toLocaleDateString()}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-blue-600">${badge.milestone}</p>
                    </div>`;
                listEl.appendChild(item);
            });
            
            navigateTo('achievements');
        }

        function showInProgressPage() {
            const listEl = document.getElementById('in-progress-list');
            listEl.innerHTML = '';

            if (appState.inProgressDonations.length === 0) {
                listEl.innerHTML = `<p class="text-center text-gray-500 mt-8">no pending donations. go help someone!</p>`;
                navigateTo('inProgress');
                return;
            }
            
            const sortedDonations = [...appState.inProgressDonations].sort((a, b) => a.startTime - b.startTime);
            
            sortedDonations.forEach(donation => {
                 const item = document.createElement('div');
                item.className = 'bg-white p-5 rounded-lg shadow-md border border-gray-200';
                item.innerHTML = `
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">${donation.locationName}</h3>
                        <p class="text-gray-600 font-medium">${donation.summary}</p>
                        <p class="text-sm text-gray-500 mt-1">drop off between: ${donation.timeWindow}</p>
                    </div>`;
                listEl.appendChild(item);
            });
            navigateTo('inProgress');
        }
        
        // --- EVENT LISTENERS ---
        toggleMapBtn.addEventListener('click', () => navigateTo('map'));
        toggleProfileBtn.addEventListener('click', () => {
            updateProfileStats(); // Update stats before showing the page
            navigateTo('profile');
        });
        categorySelect.addEventListener('change', (e) => { appState.selectedCategory = e.target.value; if (appState.selectedCategory) showNeedsList(); });
        backToListBtn.addEventListener('click', () => navigateTo('list'));
        quantitySelect.addEventListener('change', (e) => { appState.committedQuantity = e.target.value; });
        submitButton.addEventListener('click', () => showConfirmationPage());
        restartButton.addEventListener('click', () => {
            appState.selectedCategory = null; appState.selectedLocation = null; appState.committedQuantity = null; categorySelect.value = "";
            navigateTo('map');
        });
        
        friendsBtn.addEventListener('click', showLeaderboardPage);
        achievementsBtn.addEventListener('click', showAchievementsPage);
        inProgressBtn.addEventListener('click', showInProgressPage);

        communityBtn.addEventListener('click', () => {
            navigateTo('heatmap');
            setTimeout(() => { // Ensure map container is visible before initializing
                if (!heatMap) {
                    initHeatMap();
                } else {
                   drawCommunityCircles(); // Redraw circles with updated data
                }
                updateHeatmapHeader(); // Refresh the numbers every time the page is viewed
                heatMap.invalidateSize(); // Important for maps in hidden containers
            }, 100);
        });
        
        backButtons.forEach(btn => btn.addEventListener('click', () => {
            updateProfileStats(); // Update stats before showing the page
            navigateTo('profile');
        }));

        // --- IMAGE UPLOAD LISTENERS ---
        profilePicUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const newImageUrl = e.target.result;
                document.getElementById('profile-pic').src = newImageUrl;
                const userInFriends = friendsData.find(f => f.name === 'maddie bhuvan');
                if (userInFriends) {
                    userInFriends.avatar = newImageUrl;
                }
            };
            reader.readAsDataURL(file);
        });

        // Event delegation for friend picture uploads
        document.getElementById('leaderboard-list').addEventListener('change', (event) => {
            if (event.target.classList.contains('friend-pic-uploader')) {
                const file = event.target.files[0];
                const friendId = event.target.dataset.friendid;
                if (!file || !friendId) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const newImageUrl = e.target.result;
                    document.getElementById(`friend-pic-${friendId}`).src = newImageUrl;
                    const friend = friendsData.find(f => f.id == friendId);
                    if (friend) {
                        friend.avatar = newImageUrl;
                        if (friend.name === 'maddie bhuvan') {
                            document.getElementById('profile-pic').src = newImageUrl;
                        }
                    }
                };
                reader.readAsDataURL(file);
            }
        });


        // --- APP INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Create the coastal buffer before initializing the map
            bufferedSfLandPolygon = createBufferedPolygon(sfLandPolygon, 0.03); // 3% inset
            
            // Calculate initial donation stats
            appState.octoberDonations = Object.values(neighborhoods).reduce((sum, n) => sum + n.donations, 0);
            appState.cumulativeDonations = appState.octoberDonations + 2391; // Start with a higher cumulative number than October

            // Initialize consistent random numbers for followers/following
            appState.followingCount = 184;
            appState.followersCount = 372;
            // Initialize followers/following based on the number of friends in the mock data.
            // The user follows most of their friends, and has some extra followers.
            appState.followingCount = friendsData.length - 1; // Follows everyone on the list except self
            appState.followersCount = friendsData.length + Math.floor(Math.random() * 5) + 2; // Has all friends as followers, plus a few more
            
            // Pre-populate achieved badges based on starting donations
            const startingDonations = friendsData.find(f => f.name === 'maddie bhuvan').donations;
            checkAndAwardBadges(0, startingDonations);
            // Manually set some past dates for realism
            const firstBadge = appState.achievedBadges.find(b => b.milestone === 1);
            if(firstBadge) firstBadge.dateAchieved = new Date('2025-04-11T12:00:00Z');
            const fifthBadge = appState.achievedBadges.find(b => b.milestone === 5);
            if(fifthBadge) fifthBadge.dateAchieved = new Date('2025-06-23T12:00:00Z');
            const tenthBadge = appState.achievedBadges.find(b => b.milestone === 10);
            if(tenthBadge) tenthBadge.dateAchieved = new Date('2025-08-02T12:00:00Z');


            initMap();
            navigateTo('map');
        });
    </script>
</body>
</html>




